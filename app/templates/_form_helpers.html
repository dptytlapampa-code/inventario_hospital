{% macro render_field(field, form_group_class='mb-3', label_class='form-label', input_class='form-control', help_text=None, input_type=None, placeholder=None, min_value=None, max_value=None, step=None, rows=None, extra_attrs=None) -%}
  <div class="{{ form_group_class }}">
    {{ field.label(class=label_class) }}
    {{ render_input_field(field, input_class ~ (' is-invalid' if field.errors else ''), input_type=input_type, placeholder=placeholder, min_value=min_value, max_value=max_value, step=step, rows=rows, extra_attrs=extra_attrs) }}
    {% set description = help_text or field.description %}
    {% if description %}
      <div class="form-text">{{ description }}</div>
    {% endif %}
    {% if field.errors %}
      {% for error in field.errors %}
        <div class="invalid-feedback d-block">{{ error }}</div>
      {% endfor %}
    {% endif %}
  </div>
{%- endmacro %}

{% macro render_select(field, form_group_class='mb-3', label_class='form-label', input_class='form-select', multiple=None, size=None, extra_attrs=None, class_=None) -%}
  {% set select_class = input_class %}
  {% if class_ %}
    {% set select_class = input_class ~ ' ' ~ class_ %}
  {% endif %}
  {% set attrs = build_select_attrs(field, multiple=multiple, size=size, extra_attrs=extra_attrs) %}
  {{ render_field(field, form_group_class=form_group_class, label_class=label_class, input_class=select_class|trim, extra_attrs=attrs) }}
{%- endmacro %}

{% macro render_lookup(field, hidden_field, endpoint, form_group_class='mb-3', label_class='form-label', placeholder='', params=None, required_params=None, reset_targets=None, requires_message=None, extra_attrs=None) -%}
  {% set attrs = {
    'class': 'form-control' ~ (' is-invalid' if field.errors else ''),
    'autocomplete': 'off',
    'placeholder': placeholder,
    'data-lookup': 'true',
    'data-lookup-url': endpoint,
    'data-lookup-hidden': hidden_field.id,
  } %}
  {% if params %}
    {% set attrs = attrs | combine({'data-lookup-params': params|tojson}) %}
  {% endif %}
  {% if required_params %}
    {% set attrs = attrs | combine({'data-lookup-required': required_params|tojson}) %}
  {% endif %}
  {% if reset_targets %}
    {% set attrs = attrs | combine({'data-lookup-reset': reset_targets|tojson}) %}
  {% endif %}
  {% if requires_message %}
    {% set attrs = attrs | combine({'data-lookup-required-message': requires_message}) %}
  {% endif %}
  {% if extra_attrs %}
    {% set attrs = attrs | combine(extra_attrs) %}
  {% endif %}
  <div class="{{ form_group_class }}">
    {{ field.label(class=label_class, for=field.id) }}
    <div class="lookup-control">
      <div class="input-group">
        <input type="text" id="{{ field.id }}" name="{{ field.name }}" value="{{ field.data or '' }}"{% for key, value in attrs.items() if value is not none %} {{ key }}="{{ value|safe if 'data-' in key else value }}"{% endfor %}>
        <button class="btn btn-outline-secondary" type="button" title="Mostrar todo" data-lookup-show-all>…</button>
        <button class="btn btn-outline-secondary" type="button" title="Limpiar" data-lookup-clear>&times;</button>
      </div>
      {{ hidden_field() }}
      <div class="lookup-results list-group d-none" data-lookup-results role="listbox" aria-label="Opciones para {{ field.label.text }}"></div>
    </div>
    {% if field.description %}
      <div class="form-text">{{ field.description }}</div>
    {% endif %}
    {% if field.errors %}
      {% for error in field.errors %}
        <div class="invalid-feedback d-block">{{ error }}</div>
      {% endfor %}
    {% endif %}
  </div>
{%- endmacro %}

{% macro render_ajax_select(field, endpoint, form_group_class='mb-3', label_class='form-label', placeholder='Escriba para buscar…', input_class='form-select', multiple=None, depends_on=None, depends_message=None, min_chars=1, extra_attrs=None, class_='') -%}
  {% set attrs = {
    'data-control': 'tom-select',
    'data-endpoint': endpoint,
    'data-placeholder': placeholder,
    'data-min-chars': min_chars,
  } %}
  {% if depends_on %}
    {% set attrs = attrs | combine({'data-dependent-field': depends_on}) %}
  {% endif %}
  {% if depends_message %}
    {% set attrs = attrs | combine({'data-dependent-message': depends_message}) %}
  {% endif %}
  {% if extra_attrs %}
    {% set attrs = attrs | combine(extra_attrs) %}
  {% endif %}
  {% set select_class = (input_class ~ ' js-tom-select ' ~ class_) if class_ else (input_class ~ ' js-tom-select') %}
  {{ render_select(field, form_group_class=form_group_class, label_class=label_class, input_class=select_class|trim, multiple=multiple, extra_attrs=attrs) }}
{%- endmacro %}

{% macro render_textarea(field, form_group_class='mb-3', label_class='form-label', input_class='form-control', rows=3, help_text=None, placeholder=None, extra_attrs=None) -%}
  {{ render_field(field, form_group_class=form_group_class, label_class=label_class, input_class=input_class, rows=rows, help_text=help_text, placeholder=placeholder, extra_attrs=extra_attrs) }}
{%- endmacro %}

{% macro render_checkbox(field, form_group_class='form-check mb-3', input_class='form-check-input', label_class='form-check-label', extra_attrs=None) -%}
  <div class="{{ form_group_class }}">
    {{ render_input_field(field, input_class ~ (' is-invalid' if field.errors else ''), extra_attrs=extra_attrs) }}
    {{ field.label(class=label_class) }}
    {% if field.errors %}
      {% for error in field.errors %}
        <div class="invalid-feedback d-block">{{ error }}</div>
      {% endfor %}
    {% endif %}
  </div>
{%- endmacro %}
