{% extends 'base.html' %}
{% from '_pagination.html' import render_pagination %}
{% block title %}VLANs{% endblock %}
{% block header_title %}Gestión de VLANs{% endblock %}
{% block content %}
<div class="form-section">
  <div class="section-header">Filtros</div>
  <div class="section-body">
    <form class="table-filter" method="get">
      <div>
        <label class="form-label" for="buscarVlan">Buscar</label>
        <input id="buscarVlan" name="q" value="{{ buscar }}" class="form-control" placeholder="Nombre o identificador" />
      </div>
      <div>
        <label class="form-label" for="hospitalFiltro">Hospital</label>
        <select
          id="hospitalFiltro"
          name="hospital_id"
          class="form-select js-tom-select"
          data-control="tom-select"
          data-endpoint="{{ url_for('api.search_hospitales') }}"
          data-placeholder="Todos los hospitales"
          data-allow-clear="true"
        >
          <option value=""></option>
          {% if selected_hospital %}
          <option value="{{ selected_hospital.id }}" selected>{{ selected_hospital.nombre }}</option>
          {% endif %}
        </select>
      </div>
      <div class="align-self-end">
        <button type="submit" class="btn btn-primary">Aplicar</button>
      </div>
      {% if has_role('superadmin') %}
      <div class="ms-auto align-self-end">
        <a class="btn btn-success" href="{{ url_for('vlans.crear_vlan', hospital_id=hospital_id) }}">Nueva VLAN</a>
      </div>
      {% endif %}
    </form>
  </div>
</div>
<div class="table-responsive bg-white rounded shadow-sm">
  <table class="table table-hover align-middle mb-0">
    <thead class="table-light">
      <tr>
        <th>Nombre</th>
        <th>Identificador</th>
        <th>Hospital</th>
        <th>Servicio</th>
        <th>Oficina</th>
        <th class="text-center">Dispositivos</th>
        <th class="text-end">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for vlan in vlans %}
      <tr>
        <td>{{ vlan.nombre }}</td>
        <td><span class="badge text-bg-primary">{{ vlan.identificador }}</span></td>
        <td>{{ vlan.hospital.nombre }}</td>
        <td>{% if vlan.servicio %}{{ vlan.servicio.nombre }}{% else %}<span class="text-muted">Sin servicio</span>{% endif %}</td>
        <td>{% if vlan.oficina %}{{ vlan.oficina.nombre }}{% else %}<span class="text-muted">Sin oficina</span>{% endif %}</td>
        <td class="text-center">
          <span class="badge text-bg-secondary">{{ vlan.dispositivos|length }}</span>
        </td>
        <td class="text-end">
          <div class="btn-group" role="group" aria-label="Acciones VLAN">
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('vlans.detalle', vlan_id=vlan.id) }}">Ver</a>
            {% if has_role('superadmin') %}
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('vlans.editar_vlan', vlan_id=vlan.id) }}">Editar</a>
            <form class="d-inline" method="post" action="{{ url_for('vlans.eliminar_vlan', vlan_id=vlan.id) }}" onsubmit="return confirm('¿Eliminar la VLAN seleccionada?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
            </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="7" class="text-center text-muted py-4">No se encontraron VLAN registradas.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{{ render_pagination(pagination) }}
{% endblock %}
