{% extends 'base.html' %}
{% from '_form_helpers.html' import render_field, render_select, render_textarea, render_lookup, render_checkbox %}
{% block title %}{{ titulo }}{% endblock %}
{% block header_title %}{{ titulo }}{% endblock %}
{% block content %}
<form method="post" novalidate class="needs-validation">
  {{ form.hidden_tag() }}
  <div class="form-section">
    <div class="section-header">Ubicación</div>
    <div class="section-body row g-3">
      {{ render_lookup(
        form.hospital_busqueda,
        form.hospital_id,
        url_for('api.search_hospitales'),
        form_group_class='col-12 col-md-6',
        placeholder='Buscar hospital',
        reset_targets=[
          form.servicio_busqueda.id,
          form.oficina_busqueda.id
        ]
      ) }}
      {{ render_lookup(
        form.servicio_busqueda,
        form.servicio_id,
        url_for('api.search_servicios_lookup'),
        form_group_class='col-12 col-md-6',
        placeholder='Buscar servicio',
        params={'hospital_id': form.hospital_id.id},
        required_params=['hospital_id'],
        reset_targets=[form.oficina_busqueda.id],
        requires_message='Seleccione un hospital para buscar servicios',
        allow_empty=True,
        empty_label='Sin definir'
      ) }}
      {{ render_lookup(
        form.oficina_busqueda,
        form.oficina_id,
        url_for('api.search_oficinas_lookup'),
        form_group_class='col-12 col-md-6',
        placeholder='Buscar oficina',
        params={'hospital_id': form.hospital_id.id, 'servicio_id': form.servicio_id.id},
        required_params=['hospital_id'],
        requires_message='Seleccione un hospital para buscar oficinas',
        allow_empty=True,
        empty_label='Sin definir'
      ) }}
      {{ render_field(form.responsable, form_group_class='col-12 col-md-6', placeholder='Responsable del equipo') }}
    </div>
  </div>
  <div class="form-section">
    <div class="section-header">Identificación y estado</div>
    <div class="section-body row g-3">
      <div class="col-12 col-md-6" data-serial-container>
        <label class="form-label" for="{{ form.numero_serie.id }}">Número de serie</label>
        {{ render_input_field(form.numero_serie, 'form-control' ~ (' is-invalid' if form.numero_serie.errors else ''), placeholder='Número de serie', extra_attrs={'data-serial-input': 'true'}) }}
        <div class="form-text d-none" data-serial-message>Se generará un código interno al guardar.</div>
        {% for error in form.numero_serie.errors %}
        <div class="invalid-feedback d-block">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-6 align-self-end">
        <div class="form-check mb-0">
          {{ render_input_field(form.sin_numero_serie, 'form-check-input' ~ (' is-invalid' if form.sin_numero_serie.errors else ''), extra_attrs={'data-serial-toggle': 'true'}) }}
          {{ form.sin_numero_serie.label(class='form-check-label') }}
          {% for error in form.sin_numero_serie.errors %}
          <div class="invalid-feedback d-block">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
      {{ render_field(form.codigo, form_group_class='col-12 col-md-6', placeholder='Código patrimonial') }}
      {{ render_select(form.tipo, form_group_class='col-12 col-md-3', label_class='form-label') }}
      {{ render_select(form.estado, form_group_class='col-12 col-md-3', label_class='form-label') }}
    </div>
  </div>
  <div class="form-section">
    <div class="section-header">Detalles del equipo</div>
    <div class="section-body row g-3">
      {{ render_textarea(form.descripcion, form_group_class='col-12', rows=3, placeholder='Descripción breve del equipo') }}
      {{ render_field(form.marca, form_group_class='col-12 col-md-4', placeholder='Marca') }}
      {{ render_field(form.modelo, form_group_class='col-12 col-md-4', placeholder='Modelo') }}
      {{ render_field(form.fecha_compra, form_group_class='col-12 col-md-4', input_type='date') }}
      {{ render_field(form.fecha_instalacion, form_group_class='col-12 col-md-4', input_type='date') }}
      {{ render_field(form.garantia_hasta, form_group_class='col-12 col-md-4', input_type='date') }}
      {{ render_textarea(form.observaciones, form_group_class='col-12', rows=3, placeholder='Observaciones relevantes') }}
    </div>
  </div>
  <div class="d-flex flex-column flex-md-row gap-2 justify-content-end">
    {{ form.submit(class='btn btn-primary px-4') }}
    <a class="btn btn-outline-secondary" href="{{ url_for('equipos.listar') }}">Cancelar</a>
  </div>
</form>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/forms/equipos_form.js') }}"></script>
{% endblock %}
