{% from '_form_helpers.html' import render_field, render_select, render_textarea, render_ajax_select %}
<form
  method="post"
  novalidate
  class="needs-validation"
>
  {{ form.hidden_tag() }}
  <div class="form-section">
    <div class="section-header">Ubicación</div>
    <div class="section-body row g-3">
      <div class="col-12 col-md-4">
        {{ render_ajax_select(
          form.hospital_id,
          url_for('api.search_hospitales'),
          form_group_class='mb-3',
          label_class='form-label fw-semibold',
          input_class='form-select',
          placeholder='Seleccione un hospital'
        ) }}
      </div>
      <div class="col-12 col-md-4">
        {{ render_ajax_select(
          form.servicio_id,
          url_for('api.search_servicios'),
          form_group_class='mb-3',
          label_class='form-label fw-semibold',
          input_class='form-select',
          placeholder='Sin servicio asignado',
          depends_on=form.hospital_id.id,
          depends_message='Seleccione un hospital para filtrar servicios',
          dependency_param='hospital_id',
          allow_clear=True
        ) }}
      </div>
      <div class="col-12 col-md-4">
        {{ render_ajax_select(
          form.oficina_id,
          url_for('api.search_oficinas'),
          form_group_class='mb-3',
          label_class='form-label fw-semibold',
          input_class='form-select',
          placeholder='Sin oficina asignada',
          depends_on=form.servicio_id.id,
          depends_message='Seleccione un servicio para filtrar oficinas',
          dependency_param='servicio_id',
          extra_params=[{'field': form.hospital_id.id, 'param': 'hospital_id'}],
          allow_clear=True
        ) }}
      </div>
      {{ render_field(form.responsable, form_group_class='col-12 col-md-6', placeholder='Responsable del equipo') }}
    </div>
  </div>
  <div class="form-section">
    <div class="section-header">Identificación y estado</div>
    <div class="section-body row g-3">
      <div class="col-12 col-md-6" data-serial-container>
        <label class="form-label" for="{{ form.numero_serie.id }}">Número de serie</label>
        {{ render_input_field(form.numero_serie, 'form-control' ~ (' is-invalid' if form.numero_serie.errors else ''), placeholder='Número de serie', extra_attrs={'data-serial-input': 'true'}) }}
        <div class="form-text d-none" data-serial-message>Se generará un código interno al guardar.</div>
        {% for error in form.numero_serie.errors %}
        <div class="invalid-feedback d-block">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-6 align-self-end">
        <div class="form-check mb-0">
          {{ render_input_field(form.sin_numero_serie, 'form-check-input' ~ (' is-invalid' if form.sin_numero_serie.errors else ''), extra_attrs={'data-serial-toggle': 'true'}) }}
          {{ form.sin_numero_serie.label(class='form-check-label') }}
          {% for error in form.sin_numero_serie.errors %}
          <div class="invalid-feedback d-block">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
      {{ render_field(form.codigo, form_group_class='col-12 col-md-6', placeholder='Código patrimonial') }}
      {{ render_select(form.tipo, form_group_class='col-12 col-md-3', label_class='form-label') }}
      {{ render_select(form.estado, form_group_class='col-12 col-md-3', label_class='form-label') }}
    </div>
  </div>
  <div class="form-section">
    <div class="section-header">Detalles del equipo</div>
    <div class="section-body row g-3">
      {{ render_textarea(form.descripcion, form_group_class='col-12', rows=3, placeholder='Descripción breve del equipo') }}
      {{ render_field(form.marca, form_group_class='col-12 col-md-4', placeholder='Marca') }}
      {{ render_field(form.modelo, form_group_class='col-12 col-md-4', placeholder='Modelo') }}
      {{ render_field(form.fecha_ingreso, form_group_class='col-12 col-md-4', input_type='text') }}
      {{ render_field(form.fecha_instalacion, form_group_class='col-12 col-md-4', input_type='text') }}
      {{ render_field(form.garantia_hasta, form_group_class='col-12 col-md-4', input_type='text') }}
      {{ render_textarea(form.observaciones, form_group_class='col-12', rows=3, placeholder='Observaciones relevantes') }}
    </div>
  </div>
  <div class="form-section">
    <div class="section-header d-flex align-items-center justify-content-between">
      <span>Alta del equipo</span>
      <div class="form-check form-switch mb-0">
        {{ form.es_nuevo(class='form-check-input', id='esNuevoSwitch') }}
        <label class="form-check-label" for="esNuevoSwitch">Equipo nuevo</label>
      </div>
    </div>
    <div class="section-body row g-3" data-nuevo-fields hidden>
      {{ render_field(form.expediente, form_group_class='col-12 col-md-6', placeholder='Número de expediente') }}
      {{ render_field(form.anio_expediente, form_group_class='col-12 col-md-3', input_type='number') }}
      {{ render_field(form.orden_compra, form_group_class='col-12 col-md-6', placeholder='Orden de compra') }}
      {{ render_select(form.tipo_adquisicion, form_group_class='col-12 col-md-3', label_class='form-label') }}
    </div>
  </div>
  <div class="d-flex flex-column flex-md-row gap-2 justify-content-end">
    {{ form.submit(class='btn btn-primary px-4') }}
    <a class="btn btn-outline-secondary" href="{{ url_for('equipos.listar') }}">Cancelar</a>
  </div>
</form>
